# Не блокирующий TCP чат

Написан на Java.
Работа проверялась на ArchLinux дистрибутиве.

## Запуск
1. Необходимо склинировать себе репозиторий, после чего через командную сторку скомпилировать все файлы `.java` в папке `src\main\java` командой:
```sh
$ javac *.java
```  
2. Для запуска сервера необходимо ввести в консоль команду:
```sh
$ java ServerMain
``` 
3. Для запуска клиента необходимо ввести в консоль команду:
```sh
$ java ClientMain
``` 

При запуске сервера и/или клинета можно передать в качестве входных параметров хост и порт:

- Сервер:

![Передача параметров при старте сервера](files\images\server parameters.png)

- Клиент:

![Передача параметров при старте клиента](files\images\client parameters.png)

Если этого не сделать, будут использоваться дефолтные значения:

- Сервер:

![Дефолтные параметры при старте сервера](files\images\server default.png)

- Клиент:

![Дефолтные параметры при старте клиента](files\images\client default.png)

## Описание команд
Сервер поддерживает 2 команды:
- `/users` - В терминале отображаются все подключенные к серверу пользователи
- `/stop` - Выключение сервера

Клинет поддерживает 2 команды:
- `/file` - Отправка файла. После `/file` ставится проблем и указывается путь до файла. Максимальный размер файла - 5 MB.
- `/quit` - Выключение клинета

## Протокол

Протокол подразумевает последовательность действий:
1. **Установка соединения**. Может быть только первым, в остальных ситуациях не является корректным.
2. **Передача сообщений**. Выполняется в любой момент между установкой соединения и его завершением.
3. **Завершение соединения**. Может быть выполнено только после установки соединения.

## Формат пакета:
#### От клиента:
- Без файла:

message |
--- | 

- С файлом:

/file | fileBytesLength| filename |
--- | --- | --- |

fileBytes| 
--- | 

#### От сервера:
- Без файла:

username | message| 
--- | --- | 

- С файлом:

userName | /file | filename | fileBytesLength |
--- | --- | --- | --- |

fileBytes| 
--- | 

## Соединение:
После подклчючения клиента к серверу происходит ожидание ввода имени пользователем. 
Сначала происходит проверка, что имя пользователя состоит только из латинских букв и цифр. Далее проходит проверка, что на сервере нет пользователя с таким именем.  
Для этого на сервер отправляет пакет с именем пользователя. На стороне сервера для каждого пользователя создается сокет. 
Далее происходит проверка, что такого пользователя еще нет и если такой пользователь уже есть, отсылается клиенту сообщение, что такое имя уже сущетсвует и ожидаение нового имени. 
При успешной проверке всем клиента отправляется сообщение, что пользователь подключен к чату. Сообщение у пользователей имеет формат: `<HH:MM>[UserName]: joined`.

После этого пользователь может писать соообщения и отправлять файлы.

При отправке сообщения всем пользователем оно приходит в формате: `<HH:MM>[UserName]: message`

При отправке файла у всех пользователей пользователей отображаются следующие сообщения:

- Если пользователь в первый раз в чате:
```
<HH:MM>[UserName]: Sent the file: fileName ( fileBytes bytes)
<HH:MM>[Client]: Directory created: C:\Users\User\Desktop\UserName
<HH:MM>[Client]: File saved: fileName
```

- Если пользователь уже был в чате и получал файлы:

    - Если файл новый:
    ```
    <HH:MM>[UserName]: Sent the file: fileName ( fileBytes bytes)
    <HH:MM>[Client]: File saved: fileName
    ```

    - Если файл уже был получен ранее:
    ```
    <HH:MM>[UserName]: Sent the file: fileName ( fileBytes bytes)
    <HH:MM>[Client]: File overwriting:: fileName
    ```

При отключении пользователя всем в чате отправляется сообщение формата: `<HH:MM>[UserName]: quited`

## Завершение работы

Завершение соединения может произойти и со стороны клиента, и со стороны сервера:

#### Со стороны клиента:
- При отправке клиентом сообщения `/quit`:

![Остановка клиента через /quit](files\images\stop client quit.png)

- При остановке сервера:

![Остановка клиента при остановке сервера](files\images\stop client clise server.png)

- При закрытии приложения. Закрывается клиентский сокет и всем пользователям отправляется сообщение:

![Закрытие клиентского приложения](files\images\stop client close.png)

#### Со стороны сервера:
- Только при отправке в консоль сообщения `/stop`:

![Остановка сервера через /stop](files\images\stop client clise server.png)

