# DHCP-клиент

Написан на Java.

## Запуск
1. Необходимо склинировать себе репозиторий, после чего через командную сторку скомпилировать все файлы `.java` в папке `src\main\java` командой:
```sh
$ javac *.java
```  
2. Для запуска сервера необходимо ввести в консоль команду:
```sh
$ java DHCPClientMain
``` 

## Протокол

DHCP - сетевой протокол, позволяющий сетевым устройствам автоматически получать IP-адрес и другие параметры, необходимые 
для работы в сети TCP/IP. Для автоматической конфигурации компьютер-клиент на этапе конфигурации сетевого устройства 
обращается к серверу DHCP и получает от него нужные параметры. На стороне сервера может задавться диапазон адресов, 
распределяемых сервером среди компьютеров, что позволяет избежать ручной настройки компьютеров сети и уменьшает количество ошибок. 
Протокол DHCP используется в большинстве сетей TCP/IP.

Существует 3 способа определения IP:
- Ручное распределение. При этом способе сетевой администратор сопоставляет аппаратному адресу (для Ethernet-сетей это MAC-адрес) 
каждого клиентского компьютера определённый IP-адрес. Фактически данный способ распределения адресов отличается от ручной 
настройки каждого компьютера лишь тем, что сведения об адресах хранятся централизованно (на сервере DHCP), 
и потому их проще изменять при необходимости.

- Автоматическое распределение. При данном способе каждому компьютеру на постоянное использование выделяется произвольный 
свободный IP-адрес из определённого администратором диапазона.

- Динамическое распределение. Этот способ аналогичен автоматическому распределению за исключением того, что адрес выдаётся 
компьютеру не на постоянное пользование, а на определённый срок. Это называется арендой адреса. 
По истечении срока аренды IP-адрес вновь считается свободным, и клиент обязан запросить новый (он, впрочем, может оказаться тем же самым). 
Кроме того, клиент сам может отказаться от полученного адреса.

Также стоит отметить, что передача данных производится при помощи протокола UDP. По умолчанию запросы от клиента делаются к серверу на порт 67, 
сервер в свою очередь отвечает клиенту на порт 68, выдавая адрес IP и другую необходимую информацию, такую, как сетевую маску, маршрутизатор и серверы DNS.
   
 Поле	| Описание	| Длина (в байтах) |
| --	  | --      	| --               |
|op	   | Тип сообщения. Например может принимать значения: BOOTREQUEST (0x01, запрос от клиента к серверу) и BOOTREPLY (0x02, ответ от сервера к клиенту). |	1 |
| htype|	Тип аппаратного адреса. Допустимые значения этого поля определены в RFC 1700 «Assigned Numbers». Например, для MAC-адреса Ethernet это поле принимает значение 0x01. |1|
|hlen|	Длина аппаратного адреса в байтах. Для MAC-адреса Ethernet —0x06.|	1|
|hops|	Количество промежуточных маршрутизаторов (так называемых агентов ретрансляции DHCP), через которые прошло сообщение. Клиент устанавливает это поле в 0x00.|	1|
|xid|	Уникальный идентификатор транзакции в 4 байта, генерируемый клиентом в начале процесса получения адреса.|	4|
|secs|	Время в секундах с момента начала процесса получения адреса. Может не использоваться (в этом случае оно устанавливается в 0x0000).|	2|
|flags|	Поле для флагов — специальных параметров протокола DHCP.|	2|
|ciaddr|	IP-адрес клиента. Заполняется только в том случае, если клиент уже имеет собственный IP-адрес и способен отвечать на запросы ARP (это возможно, если клиент выполняет процедуру обновления адреса по истечении срока аренды).	|4|
|yiaddr|	Новый IP-адрес клиента, предложенный сервером.	|4|
|siaddr|	IP-адрес сервера. Возвращается в предложении DHCP (см. ниже).	|4|
|giaddr|	IP-адрес агента ретрансляции, если таковой участвовал в процессе доставки сообщения DHCP до сервера.|	4|
|chaddr|	Аппаратный адрес (обычно MAC-адрес) клиента.	|16|
|sname|	Необязательное имя сервера в виде нуль-терминированной строки.	|64|
|file|	Необязательное имя файла на сервере, используемое бездисковыми рабочими станциями при удалённой загрузке. Как и sname, представлено в виде нуль-терминированной строки.	|128|
|options|	Поле опций DHCP. Здесь указываются различные дополнительные параметры конфигурации. В начале этого поля указываются четыре особых байта со значениями 99, 130, 83, 99 («волшебные числа»), позволяющие серверу определить наличие этого поля. Поле имеет переменную длину, однако DHCP-клиент должен быть готов принять DHCP-сообщение длиной в 576 байт (в этом сообщении поле options имеет длину 340 байт).	|переменная|

### Опции DHCP:

Одними из самых частых опций являеются:
* IP-адрес маршрутизатора по умолчанию;
* Маска подсети;
* Адреса серверов DNS;
* Имя домена DNS.

Всего существует около 100 различных опций (полный список можно найти в [спецификации оприй DHCP](https://datatracker.ietf.org/doc/html/rfc2132)), таких как:

 Код	| Название	| Длина (в байтах) |
| 50 | Requested IP address | 4 |
| 51 | IP address Lease Time | 4 |
| 52 | Option Overload | 1 |
| 53 | DHCP Message Type | 1 |
| 54 | Server Identifier | 4 |
| 55 | Parameter Request List | минимум 1 октет |
| 56 | Message | минимум 1 октет |
| 255 | End | 0 |

### Формат пакета:

На рисунке ниже можно увидеть формат пакетов DHCP:

![DHCP packet example](files\images\DHCP packet example.png)

### Принцип работы цикла DORA:

Процесс получения IP состоит из 4-х этапов: Discovery, Offer, Request, и Acknowledgement. Их часто сокращают по первым буквам: DORA.

* *Discovery*: 

    Клиент рассылает широковещательный UDP запрос (`DHCPDISCOVER`) по всей сети с целью обнаружить доступные DHCP-серверы и запросом получить IP-адрес. 
    Клиент отправляет сообщение с указанием источника `0.0.0.0`, если IP адрес еще неизвестен. А в роли адреса назначения выступает широковещательный адрес `255.255.255.255`
    
    Кроме того, клиент заполняет опции в пакете:
    * В поле `xid` записывается идентификатор транзакции, который должен быть уникальным для каждого пользователя. Данный идентификатор позволяет отличать процессы получения IP-адресов друг от друга
    * в поле `chaddr` записывается аппаратный адрес (MAC-адрес) клиента
    * Остальные опции могут быть не указаны (например прошлый ip и т.д.)
    
* *Offer*:

    Получив сообщение от клиента, сервер определяет требуемую конфигурацию клиента в соответствии с указанными сетевым администратором настройками. 
    Сервер отправляет ему ответ (`DHCPOFFER`), в котором предлагает конфигурацию. Предлагаемый клиенту IP-адрес указывается в поле `yiaddr`. 
    Прочие параметры (такие, как адреса маршрутизаторов и DNS-серверов) указываются в виде опций в соответствующем поле. 
    Это сообщение DHCP-сервер отправляет хосту, пославшему `DHCPDISCOVER`, на его MAC. 

* *Request*:

    Выбрав одну из конфигураций, предложенных DHCP-серверами, клиент отправляет запрос DHCP (`DHCPREQUEST`). 
    Он рассылается широковещательно, при этом к опциям, указанным клиентом в сообщении `DHCPDISCOVER`, добавляется специальная 
    опция — идентификатор сервера — указывающая адрес DHCP-сервера.

* *Acknowledgement*:

    Сервер, получивший `DHCPREQUEST`, отправляет пакет формата `DHCPACK`, в котором в очередной раз перечисляет сетевые настройки, предназначенные для данного клиента.
  

## Реализация:
   После запуска программы создается новый поток пользователя, в котором сразу создается новый DatagramSocket с портом `67` и хостом `0.0.0.0`.
   
   Затем начинается фаза `Discover`, во время которой формируется первичный запрос, в который в качестве опций записывается флаг `DHCPDISCOVER`.
   Данный запрос отправляется по широковещательному адресу `255.255.255.255` и порту `68`
   
   После этого происходит получение `Offer` от сервера. 
   
   Далее начинается фаза `Request`, во время которой формируется пакет с опцией `DHCPREQUEST` и отправляется на адрес сервера, полученного
   из `Offer.siAddr`.
   Запрос отправляется уже непосредственно по адресу сервера.
   
   Наконец, мы получаем `Acknowledge`, в котором смотрим на его опции и проверяем, что IP был выдан.
   В соответствии с каждым кодом выдаем клиенту сообщение от успехе/неудаче и завершаем работу клиента.

#### Пример работы клиента:

Запустим клиент и увидим, что сервер выделил ему свободный IP:

   ![TFTP client](files\images\DHCP client result.png)   
      
   То есть, клиент совершает полный цикл DORА, после чего сервер выделяет ему ip 192.168.1.1    
   
Теперь запустим еще один клиент, указав ему другой MAC-адрес:

   ![TFTP client](files\images\DHCP client result 2.png)   

   Как можно увидеть, цикл DORA так же выполнился и пользователю выдался следующий свободный ip-адрес.
   
В результате можно сделать вывод, что клиент работает полностью корректно

## Завершение работы

Клиент автоматически завершает свою работу после прохождения всего цикла DORA.
